<script>
	import { tick } from 'svelte';
	import { onMount } from 'svelte';
	import scrollama from 'scrollama';
	import Wide from './Wide.svelte';
	import * as d3 from 'd3';
	import { tweened } from 'svelte/motion';
	import { cubicOut } from 'svelte/easing';
	import AnimatedLine from './AnimatedLine.svelte';

	const historyData = [
		[1980.0, 0.4806589206054923, 0.4637207739056066, 0.49799666776220874],
		[1980.8775510204082, 0.48451945934857577, 0.4730006619267897, 0.49841848859318816],
		[1981.7551020408164, 0.4877126587080056, 0.47637094237643396, 0.4982952429645593],
		[1982.6326530612246, 0.48995739363681423, 0.47921440744107713, 0.49858109548904395],
		[1983.5102040816328, 0.491153443139865, 0.48126926738859765, 0.4983934316776413],
		[1984.3877551020407, 0.49175865258939666, 0.4819931832491875, 0.4995660041008705],
		[1985.265306122449, 0.49084852761598086, 0.48167705197204214, 0.5017481033914919],
		[1986.142857142857, 0.49003732829442015, 0.48177266682392883, 0.5025609829881432],
		[1987.0204081632653, 0.488756665449273, 0.4767894497316547, 0.5021814512147103],
		[1987.8979591836735, 0.4847465318923696, 0.4718947432936602, 0.4967029695076235],
		[1988.7755102040817, 0.48056945660516703, 0.46796663260442983, 0.4910033553443327],
		[1989.6530612244899, 0.47672839366104824, 0.46372138283732056, 0.4863004300109992],
		[1990.530612244898, 0.47266332098290853, 0.46137000599082967, 0.48229087452000385],
		[1991.408163265306, 0.46977176404277543, 0.4591164730377386, 0.4811076758651325],
		[1992.2857142857142, 0.46657182294893573, 0.45616040656500445, 0.4769241455969677],
		[1993.1632653061224, 0.46236797152278086, 0.4520876413359929, 0.4730255314061651],
		[1994.0408163265306, 0.45665667314028724, 0.44544608938417696, 0.466609279804743],
		[1994.9183673469388, 0.4507366845219849, 0.4395254276964806, 0.45797950812197996],
		[1995.795918367347, 0.44472058505948553, 0.4345477961060169, 0.4505535577128512],
		[1996.6734693877552, 0.4380632057291223, 0.4304248734606517, 0.44736364076209156],
		[1997.5510204081634, 0.4351341027459057, 0.4224452575099349, 0.44654122761900794],
		[1998.4285714285713, 0.4335245109832613, 0.42106640599922684, 0.44563164920521103],
		[1999.3061224489795, 0.4352484826131331, 0.4249347555678469, 0.4459550960422618],
		[2000.1836734693877, 0.4375383489751812, 0.4294482876307484, 0.4485395882716148],
		[2001.061224489796, 0.44039441104450816, 0.43212878932263266, 0.4514791597621297],
		[2001.938775510204, 0.4434680338836188, 0.43485587614156884, 0.4534871560454121],
		[2002.8163265306123, 0.44334395392024817, 0.4328772779667531, 0.4514781067537115],
		[2003.6938775510205, 0.4415615314628667, 0.42964747248970525, 0.4482931847742293],
		[2004.5714285714287, 0.4388597503584606, 0.4262469362242882, 0.44731681995699546],
		[2005.4489795918366, 0.4348489535163935, 0.42563513636883954, 0.4453061026579235],
		[2006.3265306122448, 0.4299483942321558, 0.4223609802052124, 0.44090183740604516],
		[2007.204081632653, 0.4246761324043291, 0.4168472719320562, 0.4363760838042481],
		[2008.0816326530612, 0.42095081323441264, 0.4140541101896815, 0.4312096849155296],
		[2008.9591836734694, 0.4191734464170622, 0.41159550295878944, 0.42911138883732747],
		[2009.8367346938776, 0.41989069667397416, 0.41244551241743466, 0.42837010634480066],
		[2010.7142857142858, 0.42150316432821455, 0.412038217216832, 0.4286226218109306],
		[2011.591836734694, 0.4234337667978707, 0.4141811542453979, 0.4304198573967142],
		[2012.469387755102, 0.425856854780136, 0.415523279270019, 0.43618410990524126],
		[2013.3469387755101, 0.4294041830625872, 0.41843242818845283, 0.4420662636821362],
		[2014.2244897959183, 0.4330322065263772, 0.42206338977348423, 0.44690363929748855],
		[2015.1020408163265, 0.4359740661034266, 0.42540038500609967, 0.4493068593683347],
		[2015.9795918367347, 0.43801232935152257, 0.427514730961434, 0.4489141134865804],
		[2016.857142857143, 0.439834163401315, 0.4302503466200278, 0.4496049601609684],
		[2017.734693877551, 0.44158040549126554, 0.4337116244922754, 0.4507488661495245],
		[2018.6122448979593, 0.44334880346872296, 0.4365725508644118, 0.45198027807543895],
		[2019.4897959183672, 0.4448725479057316, 0.4395763554792893, 0.45330887343504855],
		[2020.3673469387754, 0.44622186829008115, 0.4388333597783003, 0.4547450773217605],
		[2021.2448979591836, 0.44748581705067636, 0.43800225071026944, 0.45819789035408576],
		[2022.1224489795918, 0.44858242993086606, 0.433538071627936, 0.46499508656870603],
		[2023.0, 0.4492950814715755, 0.42700573209367576, 0.47292149573104325]
	];

	let margin = { top: 20, right: 20, bottom: 40, left: 45 };
	let totalWidth = 0;
	let totalHeight = 0;
	let lines = [];
	$: width = totalWidth - margin.left - margin.right;
	$: height = totalHeight - margin.top - margin.bottom;

	let xDomain = [1980, 2022];
	let yDomain = [0.4, 0.51];
	$: xScale = d3.scaleLinear().domain(xDomain).range([0, width]);
	$: yScale = d3.scaleLinear().domain(yDomain).range([height, 0]);

	let xAxis = d3.axisBottom(xScale).ticks(10);
	let yAxis = d3.axisLeft(yScale).ticks(5);

	const tickFormat = d3.format('.0%');

	const line = d3
		.line()
		.curve(d3.curveCatmullRom.alpha(0.1))
		.x((d) => xScale(d[0]))
		.y((d) => yScale(d[1]));

	const area = d3
		.area()
		.curve(d3.curveCatmullRom.alpha(0.5))
		.x((d) => xScale(d[0]))
		.y0((d) => yScale(d[2]))
		.y1((d) => yScale(d[1]));

	let color = 'white';

	onMount(() => {
		lines = [historyData];
	});
</script>

<div class="container">
	<div class="graphic">
		<Wide>
			<svg bind:clientWidth={totalWidth} bind:clientHeight={totalHeight}>
				<g class="figure" transform={`translate(${margin.left} ${margin.top})`}>
					{#each lines as data}
						{#key data}
							<path d={area(data.map((d) => [d[0], d[2], d[3]]))} fill="#fef4" stroke="none"></path>
							<path d={line(data.map((d) => [d[0], d[1]]))} fill="none" stroke={color} stroke-width="2"></path>
						{/key}
					{/each}
					<rect {width} {height} fill="none"></rect>
				</g>
				<g class="x-axis axis" transform={`translate(${margin.left} ${margin.top + height})`}>
					<g class="x-ticks ticks">
						{#each xScale.ticks(10).slice(1) as tick}
							<g transform={`translate(${xScale(tick)} 0)`}>
								<text text-anchor="middle" dominant-baseline="hanging">{tick}</text>
							</g>
						{/each}
					</g>
					<text transform={`translate(${width / 2} 30)`} text-anchor="middle" fill="white"
						>Year</text
					>
				</g>
				<g class="y-axis axis" transform={`translate(${margin.left} 0)`}>
					<g class="y-ticks ticks">
						{#each yScale.ticks(10) as tick}
							<g transform={`translate(-2 ${yScale(tick)})`}>
								<text text-anchor="end">{tickFormat(tick)}</text>
							</g>
						{/each}
					</g>
					<text
						transform={`translate(${-30} ${height / 2}) rotate(-90)`}
						text-anchor="middle"
						fill="white">Average Emotionality</text
					>
				</g>
			</svg>
		</Wide>
	</div>
</div>

<style>
	.container {
		position: relative;
	}

	.graphic {
		width: 100%;
		height: 60vh;
	}

	.graphic svg {
		width: 100%;
		height: 60vh;
	}
	svg text {
		font-family: 'Open Sans', sans-serif;
		fill: white;
	}

	.axis text {
		fill: #fff8;
	}
	.ticks text {
		font-size: 0.7em;
	}
</style>
